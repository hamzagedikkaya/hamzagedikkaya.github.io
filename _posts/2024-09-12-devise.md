---
layout: post
title: User Authentication Processes
author: Hamza Gedikkaya
categories: E-Commerce Gem
excerpt_image: /assets/images/post_imgs/login.gif
banner:
  image: /assets/images/post_imgs/devise.jpg
  height: "50vh"
tags: Ruby Rails E-Commerce Gem Devise Letter-Opener
top: 4
---

## Gem Devise

Devise is a flexible authentication solution for Rails based on Warden. It provides a range of features for user authentication, including registration, password recovery, and more.

1. **Add Devise to Your Gemfile:**

    ```ruby
    gem "devise"
    ```

2. **Install the Gem and Set Up Devise:**

    ```bash
    bundle install
    rails generate devise:install
    ```

3. **Generate User Model (if not already present):**

    Since your initial migration file already includes a User model, you can skip this step if your project already has a User model. However, if you are starting from scratch, create the User model with Devise:

    ```bash
    rails generate devise User
    rails db:migrate
    ```

4. **Configure User Model with Devise Modules:**

    ```ruby
    class User < ApplicationRecord
      devise :database_authenticatable, :registerable,
            :recoverable, :rememberable, :validatable,
            :confirmable
    end
    ```

5. **Devise Modules Explained:**

    - **database_authenticatable:** Handles user authentication using credentials stored in the database.
    - **registerable:** Allows users to register and manage their accounts.
    - **recoverable:** Enables users to reset their passwords.
    - **rememberable:** Provides functionality to remember user sessions.
    - **validatable:** Automatically checks the validity of email and password.
    - **confirmable:** Requires users to confirm their email address.

### Email Confirmation (Confirmable)

The `confirmable` module allows users to verify their email addresses. After a user registers, they receive a confirmation email, and they need to click the link in this email to activate their account.

**Mailer Configuration:**

To enable sending confirmation emails, you need to configure the application's mailer.

In the development environment, add the following lines to your `config/environments/development.rb` file:

```ruby
config.action_mailer.delivery_method = :letter_opener
config.action_mailer.perform_deliveries = true
config.action_mailer.default_url_options = { host: "localhost", port: 3000 }
```

As a starting point, we can use the `letter_opener` gem to view emails. It is used for testing email delivery in Rails applications. It simulates sending emails and displays them as viewable HTML files in the browser. This allows you to easily review the designs and contents of emails before sending real ones.

**Add the Gem to Your Gemfile:**

```ruby
gem 'letter_opener'
```

```bash
bundle install
```

### View Section

For a quick setup of Devise views, you can generate the default views with:

```bash
rails generate devise:views
```

After generating the views, you can customize them as needed.

To test and view the changes, perform the following steps:


1. Update routes.rb:

    ```ruby
    Rails.application.routes.draw do
      root "home#index"
      devise_for :users
    end
    ```

2. Create home_controller.rb:

    ```ruby
    class HomeController < ApplicationController
      def index
      end
    end
    ```

3. Create or update app/views/home/index.html.erb:

    ```haml
    %h1 Welcome to the Home Page!

    - if user_signed_in?
      %p Hello, 
      = current_user.email
      %br/
      = link_to 'Edit Profile', edit_user_registration_path, class: 'btn btn-primary'
      = link_to 'Log Out', destroy_user_session_path, method: :delete, class: 'btn btn-danger'
    - else
      = link_to 'Sign In', new_user_session_path, class: 'btn btn-primary'
      %br/
      = link_to 'Sign Up', new_user_registration_path, class: 'btn btn-success'
    ```


### Update Migration

Additionally, our initial migration was configured using the `bcrypt` gem with `password_digest`. To integrate with Devise, we need to update this configuration. Specifically, we need to make the following changes to support user authentication.

**1. Generate a Migration:**

  ```bash
  rails generate migration AddConfirmableAndRenamePasswordToUsers
  ```

**2. Update the Migration File:**

  Replace the content of the generated migration file with the following:

  ```ruby
  class AddConfirmableAndRenamePasswordToUsers < ActiveRecord::Migration[7.2]
    def change
      rename_column :users, :password_digest, :encrypted_password

      add_column :users, :confirmation_token, :string
      add_column :users, :confirmed_at, :datetime
      add_column :users, :confirmation_sent_at, :datetime
      add_column :users, :unconfirmed_email, :string

      add_index :users, :confirmation_token, unique: true
    end
  end
  ```

**3. Run the Migration:**

  ```bash
  rails db:migrate
  ```


### Note

If you encounter an error like `RuntimeError in Home#index Your nodejs binary failed to load autoprefixer script file, please check if you're running a supported version (10, 12, 14+)`, it indicates that Rails is unable to load the autoprefixer script needed to process CSS files, which is related to Node.js.
To resolve this issue, you should run the following command:

```bash
brew install node
```

Further adjustments may be required as you progress.
